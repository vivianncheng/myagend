document.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("openNewTaskModalBtn"),t=document.getElementById("calendarView"),l=document.getElementById("currentMonthDisplay"),a=document.getElementById("yearSelect"),n=document.getElementById("prevMonthBtn"),i=document.getElementById("nextMonthBtn"),d=document.getElementById("themeToggleBtn");document.getElementById("themeIcon");let s=document.getElementById("exportCalendarBtn"),o=document.getElementById("importCalendarBtn"),r=document.getElementById("importFileInput"),c=document.getElementById("openWeekViewModalBtn"),m=document.getElementById("newTaskInputModalOverlay"),p=document.getElementById("closeNewTaskInputModalBtn"),y=document.getElementById("newTaskTitleInput"),u=document.getElementById("newTaskDescriptionInput"),g=document.getElementById("newTaskDueDateInput"),v=document.getElementById("newTaskTimeInput"),E=document.getElementById("addNewTaskBtn"),h=document.getElementById("newTaskColorSwatches"),L=document.getElementById("taskModalOverlay"),k=document.getElementById("closeModalBtn"),f=document.querySelector("#taskModalOverlay .modal-content"),C=document.getElementById("modalTaskTitleDisplay"),B=document.getElementById("modalTaskDescriptionDisplay"),I=document.getElementById("modalTaskDueDateDisplay"),D=document.getElementById("modalTaskTimeDisplay"),w=document.getElementById("modalTaskTitleInput"),T=document.getElementById("modalTaskDescriptionInput"),b=document.getElementById("modalTaskDueDateInput"),x=document.getElementById("modalTaskTimeInput"),M=document.getElementById("editTaskBtn"),S=document.getElementById("colorSwatches"),$=document.getElementById("modalSaveTaskBtn"),F=document.getElementById("modalDeleteTaskBtn"),_=document.getElementById("dayViewModalOverlay"),V=document.getElementById("closeDayViewModalBtn"),O=document.getElementById("dayViewDateDisplay"),N=document.getElementById("toggleDayViewBtn"),A=document.getElementById("addNewTaskInDayViewBtn"),W=document.getElementById("dayViewTasksContainer"),H=document.getElementById("dayViewTimeScheduleContainer"),Y=document.getElementById("weekViewModalOverlay"),P=document.getElementById("closeWeekViewModalBtn"),U=document.getElementById("weekViewDateRangeDisplay"),j=document.getElementById("prevWeekBtn"),q=document.getElementById("nextWeekBtn"),R=document.getElementById("weekViewContentContainer"),J=["#D3D3D3","#FFB3BA","#FFDFBA","#FFFFBA","#BAFFC9","#BAE1FF","#CBAACB","#E0BBE4","#FFC0CB"],z=[],G=new Date,K=-1,Q="",X=!1,Z=new Date;function ee(){let e=y.value.trim(),t=g.value,l=v.value.trim(),a=h.querySelector(".color-swatch.selected"),n=a?a.dataset.color:J[0];if(""===e){console.log("Task title cannot be empty."),alert("Please enter a task title.");return}if(""===t){let i=new Date;t=i.toISOString().split("T")[0],console.log("No due date specified. Defaulting to today:",t)}let d=u.value.trim(),s={title:e,description:d,completed:!1,dueDate:t,time:l,color:n};z.push(s),eC(),et(),y.value="",u.value="",g.value="",v.value="",ed(),_.classList.contains("visible")&&eu(Q),Y.classList.contains("visible")&&eL(Z)}function et(){t.innerHTML="",["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].forEach(e=>{let l=document.createElement("div");l.classList.add("day-header"),l.textContent=e,t.appendChild(l)}),l.textContent=G.toLocaleDateString("en-US",{month:"long"}),el();let e=new Date(G.getFullYear(),G.getMonth(),1),a=new Date(G.getFullYear(),G.getMonth()+1,0),n=a.getDate(),i=e.getDay();for(let d=0;d<i;d++){let s=document.createElement("div");s.classList.add("calendar-cell","inactive"),t.appendChild(s)}for(let o=1;o<=n;o++){let r=document.createElement("div");r.classList.add("calendar-cell");let c=document.createElement("div");c.classList.add("day-number"),c.textContent=o,r.appendChild(c);let m=new Date;G.getFullYear()===m.getFullYear()&&G.getMonth()===m.getMonth()&&o===m.getDate()&&r.classList.add("today");let p=new Date(G.getFullYear(),G.getMonth(),o),y=p.toISOString().split("T")[0],u=z.filter(e=>e.dueDate===y);u.sort((e,t)=>e.time&&t.time?e.time.localeCompare(t.time):e.time?-1:t.time?1:0),u.forEach(e=>{let t=ea(e.title,e.description,e.completed,e.dueDate,e.time,e.color,"calendar");r.appendChild(t)}),r.addEventListener("click",()=>ey(y)),t.appendChild(r)}let g=(7-(i+n)%7)%7;for(let v=0;v<g;v++){let E=document.createElement("div");E.classList.add("calendar-cell","inactive"),t.appendChild(E)}}function el(){a.innerHTML="";let e=G.getFullYear(),t=e-10,l=e+10;for(let n=t;n<=l;n++){let i=document.createElement("option");i.value=n,i.textContent=n,n===e&&(i.selected=!0),a.appendChild(i)}}function ea(e,t,l,a,n,i,d){let s=document.createElement("div");s.classList.add("task-item"),l&&s.classList.add("completed"),s.style.backgroundColor=i;let o=document.createElement("span");o.classList.add("task-time"),o.textContent=n?`${n}`:"";let r=document.createElement("span");r.classList.add("task-title"),r.textContent=e;let c=document.createElement("div");if(c.classList.add("task-description"),c.textContent=t||"No description","calendar"===d){let m=document.createElement("div");m.classList.add("task-header-line"),n&&m.appendChild(o),m.appendChild(r),s.appendChild(m),s.appendChild(c)}else if("dayView"===d||"weekView"===d){let p=document.createElement("div");p.style.display="flex",p.style.alignItems="baseline",p.style.width="100%",p.style.marginBottom="5px",n&&(o.style.marginRight="5px",p.appendChild(o)),r.style.fontWeight="bold",r.style.whiteSpace="normal",r.style.overflow="visible",r.style.textOverflow="unset",p.appendChild(r),s.appendChild(p),c.style.whiteSpace="normal",c.style.overflow="visible",c.style.textOverflow="unset",s.appendChild(c)}let y=z.findIndex(l=>l.title===e&&l.description===t&&l.dueDate===a&&l.time===n&&l.color===i);return s.addEventListener("click",e=>{e.stopPropagation(),es(y)}),s}function en(){m.classList.add("visible"),document.body.classList.add("modal-open"),y.value="",u.value="",g.value="",v.value="",ef(h,J[0],e=>{})}function ei(){eE(),en(),g.value=Q}function ed(){m.classList.remove("visible"),document.body.classList.remove("modal-open")}function es(e){K=e;let t=z[K];C.textContent=t.title,B.textContent=t.description||"No description provided.",I.textContent=`Due Date: ${t.dueDate}`,D.textContent=t.time?`Time: ${t.time}`:"No time scheduled",w.value=t.title,T.value=t.description,b.value=t.dueDate,x.value=t.time,f.style.borderLeftColor=t.color,ef(S,t.color,e=>{K>-1&&(z[K].color=e,eC(),et(),_.classList.contains("visible")&&eu(Q),Y.classList.contains("visible")&&eL(Z),f.style.borderLeftColor=e)}),ec("display"),L.classList.add("visible"),document.body.classList.add("modal-open")}function eo(){L.classList.remove("visible"),document.body.classList.remove("modal-open"),f.style.borderLeftColor="transparent",K=-1}function er(){let e=C.classList.contains("display-mode");e?ec("edit"):em()}function ec(e){let t=document.querySelectorAll("#taskModalOverlay .display-mode"),l=document.querySelectorAll("#taskModalOverlay .edit-mode");"display"===e?(t.forEach(e=>e.classList.remove("hidden")),l.forEach(e=>e.classList.add("hidden")),$.classList.add("hidden"),F.classList.remove("hidden"),M.style.display="block"):(t.forEach(e=>e.classList.add("hidden")),l.forEach(e=>e.classList.remove("hidden")),$.classList.remove("hidden"),F.classList.add("hidden"),M.style.display="none")}function em(){if(-1===K)return;let e=z[K];e.title=w.value.trim(),e.description=T.value.trim(),e.dueDate=b.value,e.time=x.value.trim(),eC(),et(),_.classList.contains("visible")&&eu(Q),Y.classList.contains("visible")&&eL(Z),ec("display"),C.textContent=e.title,B.textContent=e.description||"No description provided.",I.textContent=`Due Date: ${e.dueDate}`,D.textContent=e.time?`Time: ${e.time}`:"No time scheduled"}function ep(){-1!==K&&(z.splice(K,1),eC(),et(),_.classList.contains("visible")&&eu(Q),Y.classList.contains("visible")&&eL(Z),eo())}function ey(e){Q=e,O.textContent=`Tasks for ${new Date(e).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}`,eu(e),_.classList.add("visible"),document.body.classList.add("modal-open")}function eu(e){let t=z.filter(t=>t.dueDate===e);t.sort((e,t)=>e.time&&t.time?e.time.localeCompare(t.time):e.time?-1:t.time?1:0),X?(W.classList.add("hidden"),H.classList.remove("hidden"),N.textContent="Show List View",ev(t)):(W.classList.remove("hidden"),H.classList.add("hidden"),N.textContent="Show Time Schedule",eg(t))}function eg(e){if(W.innerHTML="",0===e.length){let t=document.createElement("p");t.classList.add("empty-message"),t.textContent="It's empty here. Woohoo!",W.appendChild(t);return}let l=!1;e.forEach(e=>{z.findIndex(t=>t.title===e.title&&t.description===e.description&&t.dueDate===e.dueDate&&t.time===e.time&&t.color===e.color);let t=ea(e.title,e.description,e.completed,e.dueDate,e.time,e.color,"dayView");e.time||l||(t.classList.add("no-time"),l=!0),W.appendChild(t)})}function ev(e){H.innerHTML="";let t=e.filter(e=>e.time),l=e.filter(e=>!e.time);if(0===e.length){let a=document.createElement("p");a.classList.add("empty-message"),a.textContent="It's empty here. Woohoo!",H.appendChild(a);return}for(let n=0;n<24;n++){let i=String(n).padStart(2,"0"),d=document.createElement("div");d.classList.add("time-slot");let s=document.createElement("div");s.classList.add("time-label"),s.textContent=`${i}:00`,d.appendChild(s);let o=document.createElement("div");o.classList.add("time-slot-content"),d.appendChild(o),H.appendChild(d),t.filter(e=>e.time.startsWith(i+":")).forEach(e=>{z.findIndex(t=>t.title===e.title&&t.description===e.description&&t.dueDate===e.dueDate&&t.time===e.time&&t.color===e.color);let t=ea(e.title,e.description,e.completed,e.dueDate,e.time,e.color,"dayView");o.appendChild(t)})}if(l.length>0){let r=document.createElement("div");r.classList.add("untimed-tasks-section");let c=document.createElement("h3");c.textContent="Tasks without a specific time:",r.appendChild(c);let m=document.createElement("div");m.classList.add("untimed-tasks-list"),l.forEach(e=>{z.findIndex(t=>t.title===e.title&&t.description===e.description&&t.dueDate===e.dueDate&&t.time===e.time&&t.color===e.color);let t=ea(e.title,e.description,e.completed,e.dueDate,e.time,e.color,"dayView");m.appendChild(t)}),r.appendChild(m),H.appendChild(r)}}function eE(){_.classList.remove("visible"),document.body.classList.remove("modal-open"),X=!1}function eh(e){(Z=new Date(e)).setHours(0,0,0,0);let t=new Date(Z);t.setDate(Z.getDate()+6),U.textContent=`Week of ${Z.toLocaleDateString("en-US",{month:"short",day:"numeric"})} - ${t.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}`,eL(Z),Y.classList.add("visible"),document.body.classList.add("modal-open")}function eL(e){R.innerHTML="";let t=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];for(let l=0;l<7;l++){let a=new Date(e);a.setDate(e.getDate()+l);let n=a.toISOString().split("T")[0],i=document.createElement("div");i.classList.add("week-day-column"),i.addEventListener("click",()=>ey(n));let d=document.createElement("h3");d.textContent=`${t[a.getDay()]} ${a.getDate()}`,i.appendChild(d);let s=z.filter(e=>e.dueDate===n);if(s.sort((e,t)=>e.time&&t.time?e.time.localeCompare(t.time):e.time?-1:t.time?1:0),0===s.length){let o=document.createElement("p");o.classList.add("empty-message"),o.textContent="Empty",i.appendChild(o)}else s.forEach(e=>{let t=ea(e.title,e.description,e.completed,e.dueDate,e.time,e.color,"weekView");i.appendChild(t)});R.appendChild(i)}}function ek(){Y.classList.remove("visible"),document.body.classList.remove("modal-open")}function ef(e,t,l){e.innerHTML="",J.forEach(a=>{let n=document.createElement("div");n.classList.add("color-swatch"),n.style.backgroundColor=a,n.dataset.color=a,t===a&&n.classList.add("selected"),n.addEventListener("click",()=>{e.querySelectorAll(".color-swatch").forEach(e=>e.classList.remove("selected")),n.classList.add("selected"),l&&l(a)}),e.appendChild(n)})}function eC(){chrome.storage.local.set({tasks:z},()=>{console.log("Tasks saved.")})}function eB(){chrome.storage.local.get(["tasks"],e=>{z=e.tasks||[],console.log("Tasks loaded:",z),et()})}function eI(){document.body.classList.toggle("dark-mode");let e=document.body.classList.contains("dark-mode");chrome.storage.local.set({darkMode:e},()=>{console.log("Theme preference saved:",e?"dark":"light")}),ew(e)}function eD(){chrome.storage.local.get(["darkMode"],e=>{let t=e.darkMode;t?document.body.classList.add("dark-mode"):document.body.classList.remove("dark-mode"),ew(t)})}function ew(e){let t=document.getElementById("sunPath"),l=document.getElementById("moonPath"),a=document.getElementById("logo-icon");e?(t.style.display="none",l.style.display="block",a.src="icons/icons8-calendar-50_darkmode.png"):(t.style.display="block",l.style.display="none",a.src="icons/icons8-calendar-50.png")}function eT(){chrome.storage.local.get(["tasks"],e=>{let t=JSON.stringify(e.tasks||[],null,2),l=new Blob([t],{type:"application/json"}),a=URL.createObjectURL(l),n=document.createElement("a");n.href=a,n.download="todo_calendar.json",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(a),console.log("Calendar exported."),alert("Calendar data exported to todo_calendar.json")})}function eb(e){let t=e.target.files[0];if(!t){console.log("No file selected for import.");return}let l=new FileReader;l.onload=e=>{try{let t=JSON.parse(e.target.result);if(!Array.isArray(t)||!t.every(e=>"string"==typeof e.title&&"string"==typeof e.description&&"boolean"==typeof e.completed&&"string"==typeof e.dueDate)){alert("Invalid calendar file format. Please select a valid JSON file."),console.error("Import failed: Invalid file format.");return}t.forEach(e=>{J.includes(e.color)||(e.color=J[0]),void 0===e.time&&(e.time="")}),z=t,eC(),et(),alert("Calendar data imported successfully!"),console.log("Calendar imported successfully.")}catch(l){alert("Error parsing calendar file. Please ensure it is a valid JSON."),console.error("Error parsing imported JSON:",l)}finally{r.value=""}},l.onerror=()=>{alert("Error reading file."),console.error("Error reading file:",l.error)},l.readAsText(t)}eB(),eD(),e.addEventListener("click",en),n.addEventListener("click",()=>{G.setMonth(G.getMonth()-1),et()}),i.addEventListener("click",()=>{G.setMonth(G.getMonth()+1),et()}),a.addEventListener("change",e=>{G.setFullYear(parseInt(e.target.value)),et()}),d.addEventListener("click",eI),s.addEventListener("click",eT),o.addEventListener("click",()=>r.click()),r.addEventListener("change",eb),c.addEventListener("click",()=>{let e=new Date,t=new Date(e.setDate(e.getDate()-e.getDay()));eh(t)}),p.addEventListener("click",ed),m.addEventListener("click",e=>{e.target===m&&ed()}),E.addEventListener("click",ee),y.addEventListener("keypress",e=>{"Enter"===e.key&&ee()}),u.addEventListener("keypress",e=>{"Enter"===e.key&&ee()}),g.addEventListener("keypress",e=>{"Enter"===e.key&&ee()}),v.addEventListener("keypress",e=>{"Enter"===e.key&&ee()}),k.addEventListener("click",eo),L.addEventListener("click",e=>{e.target===L&&eo()}),M.addEventListener("click",er),$.addEventListener("click",em),F.addEventListener("click",ep),V.addEventListener("click",eE),_.addEventListener("click",e=>{e.target===_&&eE()}),N.addEventListener("click",()=>{X=!X,eu(Q)}),A.addEventListener("click",ei),P.addEventListener("click",ek),Y.addEventListener("click",e=>{e.target===Y&&ek()}),j.addEventListener("click",()=>{Z.setDate(Z.getDate()-7),eh(Z)}),q.addEventListener("click",()=>{Z.setDate(Z.getDate()+7),eh(Z)})});